🔍 測試基本面資料的智能時間對齊邏輯...

🚀 開始改進的基本面智能對齊測試
================================================================================

============================================================
🧪 測試改進的基本面資料智能對齊邏輯
============================================================
📊 創建改進的測試資料...
   交易日數量: 130
   月營收資料點: 7
   財報資料點: 3

🔍 測試月營收資料動態對齊...
🔍 處理 monthly_revenue: 月營收資料，時效限制=60天
     2024-01-01: 950.0 (有效, 間隔22天)
     2024-01-02: 950.0 (有效, 間隔23天)
     2024-01-03: 950.0 (有效, 間隔24天)
     2024-01-04: 950.0 (有效, 間隔25天)
     2024-01-05: 950.0 (有效, 間隔26天)
✅ monthly_revenue 資料對齊完成: 100.0% 覆蓋率
   └─ 唯一值: 7個, 值變化: 7次
   月營收動態對齊驗證:
     ✅ 2024-01-05: 950.0
     ✅ 2024-01-29: 1000.0
     ✅ 2024-03-25: 1100.0
     ✅ 2024-05-20: 1200.0
     ✅ 2024-06-17: 1250.0

🔍 測試財報資料動態對齊...
🔍 處理 eps: 財報資料，時效限制=150天
     2024-01-01: 2.1 (有效, 間隔47天)
     2024-01-02: 2.1 (有效, 間隔48天)
     2024-01-03: 2.1 (有效, 間隔49天)
     2024-01-04: 2.1 (有效, 間隔50天)
     2024-01-05: 2.1 (有效, 間隔51天)
✅ eps 資料對齊完成: 100.0% 覆蓋率
   └─ 唯一值: 3個, 值變化: 3次
   財報動態對齊驗證:
     ✅ 2024-01-05: 2.1
     ✅ 2024-01-29: 2.1
     ✅ 2024-03-25: 2.5
     ✅ 2024-05-20: 2.8
     ✅ 2024-06-17: 2.8

📊 改進後對齊結果統計:
   月營收統計:
     覆蓋率: 100.0% (130/130)
     唯一值: 7個
     值範圍: 950.00 ~ 1250.00
   EPS統計:
     覆蓋率: 100.0% (130/130)
     唯一值: 3個
     值範圍: 2.100 ~ 2.800
[17:18:37] ✅ 改進的基本面對齊測試: SUCCESS
    詳情: 智能對齊邏輯改進有效

============================================================
🧪 測試真實資料改進對齊效果 (2330)
============================================================
⚙️ 測試2330真實基本面資料改進對齊...
   測試時間範圍: 2024-06-01 到 2025-07-31
   📝 調整測試範圍以匹配實際資料日期
   交易日數量: 304
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 266 筆資料
   實際交易日數量: 266
   🔍 診斷檢查...
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 1 筆資料
   📊 2330月營收資料筆數: 63
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 1 筆資料
   📊 2330財報資料筆數: 21
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 5 筆資料
   📅 最新5筆月營收資料:
     2025-06-01: 320515951000.0
     2025-05-01: 349566940000.0
     2025-04-01: 285956830000.0
     2025-03-01: 260008796000.0
     2025-02-01: 293288038000.0
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 3 筆資料
   📅 最新3筆財報資料:
     2025-03-31: EPS=13.95, Revenue=839253664000.0
     2024-12-31: EPS=14.45, Revenue=868461178000.0
     2024-09-30: EPS=12.55, Revenue=759692143000.0
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 1 筆資料
   📊 測試範圍內月營收資料: 13筆
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 1 筆資料
   📊 測試範圍內財報資料: 4筆
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 1 筆資料
   📊 測試結束前月營收資料: 63筆
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 1 筆資料
   📊 測試結束前財報資料: 21筆
   📅 測試日期範圍: 2024-06-03 00:00:00 ~ 2025-07-08 00:00:00
   📅 日期類型: <class 'pandas._libs.tslibs.timestamps.Timestamp'>
   📊 測試DataFrame: (266, 2), 索引類型: <class 'pandas.core.indexes.datetimes.DatetimeIndex'>
   📊 DataFrame列名: ['close', 'volume']
   📊 DataFrame非空: True
   🔍 開始計算基本面特徵...
   🔍 手動測試基本面資料查詢...
   📅 查詢日期範圍: 2024-06-03 ~ 2025-07-08
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 12 筆資料
   📊 查詢到月營收資料: 12筆
   📅 月營收日期範圍: 2024-07-01 ~ 2025-06-01
   💰 月營收樣本: 207868693000.0
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 4 筆資料
   📊 查詢到財報資料: 4筆
   📅 財報日期範圍: 2024-06-30 ~ 2025-03-31
   💹 EPS樣本: 9.55
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 63 筆資料
   📊 擴展範圍月營收資料: 63筆
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 21 筆資料
   📊 擴展範圍財報資料: 21筆
   🔍 測試智能對齊方法...
   📊 月營收序列: 63筆
🔍 處理 monthly_revenue: 月營收資料，時效限制=60天
     2024-06-03: 229620372000.0 (有效, 間隔2天)
     2024-06-04: 229620372000.0 (有效, 間隔3天)
     2024-06-05: 229620372000.0 (有效, 間隔4天)
     2024-06-06: 229620372000.0 (有效, 間隔5天)
     2024-06-07: 229620372000.0 (有效, 間隔6天)
✅ monthly_revenue 資料對齊完成: 100.0% 覆蓋率
   └─ 唯一值: 13個, 值變化: 13次
   ✅ 月營收對齊成功: 266筆
   📊 對齊覆蓋率: 266/266 = 100.0%
   📊 EPS序列: 21筆
🔍 處理 eps: 財報資料，時效限制=150天
     2024-06-03: 8.7 (有效, 間隔64天)
     2024-06-04: 8.7 (有效, 間隔65天)
     2024-06-05: 8.7 (有效, 間隔66天)
     2024-06-06: 8.7 (有效, 間隔67天)
     2024-06-07: 8.7 (有效, 間隔68天)
✅ eps 資料對齊完成: 100.0% 覆蓋率
   └─ 唯一值: 5個, 值變化: 5次
   ✅ EPS對齊成功: 266筆
   📊 對齊覆蓋率: 266/266 = 100.0%
   🔍 執行基本面特徵計算...
🔍 2330 基本面特徵計算開始，輸入DataFrame: (266, 2)
🔍 2330 查詢月營收資料: 2024-06-03 ~ 2025-07-08
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 12 筆資料
📊 2330 月營收查詢結果: 12筆
📅 2330 月營收日期範圍: 2024-07-01 ~ 2025-06-01
📊 2330 月營收序列: 12筆
🔍 2330 開始月營收智能對齊...
🔍 處理 monthly_revenue: 月營收資料，時效限制=60天
✅ monthly_revenue 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 12個, 值變化: 13次
✅ 2330 月營收對齊完成: 266筆
🔍 2330 查詢財報資料: 2024-06-03 ~ 2025-07-08
[db] 使用 SQLite: C:\Users\user\Desktop\stock\250706\lab\tse_alpha\market_data_collector\utils\..\data\stock_data.db
[db] 查詢返回 4 筆資料
📊 2330 財報查詢結果: 4筆
📅 2330 財報日期範圍: 2024-06-30 ~ 2025-03-31
📊 2330 財報序列: 4筆
🔍 2330 開始財報特徵智能對齊...
   處理財報特徵 1/14: cost_of_goods_sold
🔍 處理 cost_of_goods_sold: 財報資料，時效限制=150天
✅ cost_of_goods_sold 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 4個, 值變化: 5次
   處理財報特徵 2/14: eps
🔍 處理 eps: 財報資料，時效限制=150天
✅ eps 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 4個, 值變化: 5次
   處理財報特徵 3/14: equity_attributable_to_owners
🔍 處理 equity_attributable_to_owners: 財報資料，時效限制=150天
✅ equity_attributable_to_owners 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 4個, 值變化: 5次
   處理財報特徵 4/14: gross_profit
🔍 處理 gross_profit: 財報資料，時效限制=150天
✅ gross_profit 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 4個, 值變化: 5次
   處理財報特徵 5/14: income_after_taxes
🔍 處理 income_after_taxes: 財報資料，時效限制=150天
✅ income_after_taxes 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 4個, 值變化: 5次
   處理財報特徵 6/14: income_from_continuing_operations
🔍 處理 income_from_continuing_operations: 財報資料，時效限制=150天
✅ income_from_continuing_operations 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 4個, 值變化: 5次
   處理財報特徵 7/14: operating_expenses
🔍 處理 operating_expenses: 財報資料，時效限制=150天
✅ operating_expenses 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 4個, 值變化: 5次
   處理財報特徵 8/14: operating_income
🔍 處理 operating_income: 財報資料，時效限制=150天
✅ operating_income 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 4個, 值變化: 5次
   處理財報特徵 9/14: other_comprehensive_income
🔍 處理 other_comprehensive_income: 財報資料，時效限制=150天
✅ other_comprehensive_income 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 4個, 值變化: 5次
   處理財報特徵 10/14: pre_tax_income
🔍 處理 pre_tax_income: 財報資料，時效限制=150天
✅ pre_tax_income 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 4個, 值變化: 5次
   處理財報特徵 11/14: revenue
🔍 處理 revenue: 月營收資料，時效限制=60天
✅ revenue 資料對齊完成: 89.8% 覆蓋率
   └─ 唯一值: 4個, 值變化: 7次
   處理財報特徵 12/14: tax
🔍 處理 tax: 財報資料，時效限制=150天
✅ tax 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 4個, 值變化: 5次
   處理財報特徵 13/14: total_profit
🔍 處理 total_profit: 財報資料，時效限制=150天
✅ total_profit 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 4個, 值變化: 5次
   處理財報特徵 14/14: nonoperating_income_expense
🔍 處理 nonoperating_income_expense: 財報資料，時效限制=150天
✅ nonoperating_income_expense 資料對齊完成: 92.9% 覆蓋率
   └─ 唯一值: 4個, 值變化: 5次
✅ 2330 財報特徵對齊完成: 14個特徵
✅ 2330 基本面特徵計算完成: (266, 15)
   特徵列名: ['monthly_revenue', 'cost_of_goods_sold', 'eps', 'equity_attributable_to_owners', 'gross_profit', 'income_after_taxes', 'income_from_continuing_operations', 'operating_expenses', 'operating_income', 'other_comprehensive_income', 'pre_tax_income', 'revenue', 'tax', 'total_profit', 'nonoperating_income_expense']
   ✅ 基本面特徵計算成功: (266, 15)
   📊 特徵列名: ['monthly_revenue', 'cost_of_goods_sold', 'eps', 'equity_attributable_to_owners', 'gross_profit', 'income_after_taxes', 'income_from_continuing_operations', 'operating_expenses', 'operating_income', 'other_comprehensive_income', 'pre_tax_income', 'revenue', 'tax', 'total_profit', 'nonoperating_income_expense']
✅ 成功計算基本面特徵: (266, 15)

📊 改進後基本面特徵品質分析:
   月營收特徵:
     ├─ 覆蓋率: 92.9% (247/266)
     ├─ 唯一值數量: 12
     ├─ 值變化次數: 13
     └─ 值範圍: 207868693000 ~ 349566940000
   EPS特徵:
     ├─ 覆蓋率: 92.9% (247/266)
     ├─ 唯一值數量: 4
     ├─ 值變化次數: 5
     └─ 值範圍: 9.550 ~ 14.450
   時間點採樣:
     2024-06-03: 月營收=0, EPS=0.000
     2024-07-02: 月營收=207868693000, EPS=9.550
     2024-08-01: 月營收=256953058000, EPS=9.550
     2024-08-29: 月營收=256953058000, EPS=9.550
     2024-09-27: 月營收=250866368000, EPS=9.550

📈 整體特徵覆蓋率分析:
   ✅ 高覆蓋率特徵 (>70%): 15個
     └─ monthly_revenue: 92.9%
     └─ cost_of_goods_sold: 92.9%
     └─ eps: 92.9%
     └─ equity_attributable_to_owners: 92.9%
     └─ gross_profit: 92.9%
     └─ income_after_taxes: 92.9%
     └─ income_from_continuing_operations: 92.9%
     └─ operating_expenses: 92.9%
     └─ operating_income: 92.9%
     └─ other_comprehensive_income: 92.9%
     └─ pre_tax_income: 92.9%
     └─ revenue: 89.8%
     └─ tax: 92.9%
     └─ total_profit: 92.9%
     └─ nonoperating_income_expense: 92.9%
   🔶 中覆蓋率特徵 (30-70%): 0個
   ❌ 低覆蓋率特徵 (<30%): 0個

📊 改進效果評估:
   有效特徵比例: 100.0% (15/15)
   ✅ 基本面特徵數量正確: 15個
   ✅ 改進效果良好: 100.0%特徵有效
[17:18:37] ✅ 真實資料改進測試: SUCCESS
    詳情: 2330基本面改進對齊完成

================================================================================
📋 改進基本面對齊測試總結
================================================================================
   改進對齊邏輯測試: ✅ 成功
   真實資料改進測試: ✅ 成功

📊 總體結果: 2/2 測試成功
⏱️ 執行時間: 0.7 秒
🎉 改進基本面對齊測試 - 全部通過！
✅ 財報資料現在會正確處理季度更新特性