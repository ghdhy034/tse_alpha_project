#!/usr/bin/env python3
"""
è‚¡ç¥¨æ¸…å–®ç”Ÿæˆå™¨ - ç”Ÿæˆå°è‚¡180æ”¯è‚¡ç¥¨æ¸…å–®
"""
import sys
import os
from pathlib import Path

# æ·»åŠ è·¯å¾‘
current_dir = Path(__file__).parent
sys.path.insert(0, str(current_dir))
sys.path.insert(0, str(current_dir / "market_data_collector"))

def generate_taiwan_stock_list() -> list:
    """ç”Ÿæˆå°è‚¡180æ”¯è‚¡ç¥¨æ¸…å–®"""
    
    # å°è‚¡å¸‚å€¼å‰180å¤§è‚¡ç¥¨ï¼ˆ2024å¹´ç‰ˆæœ¬ï¼‰
    taiwan_top_180 = [
        # è¶…å¤§å‹è‚¡ (å¸‚å€¼å‰30)
        "2330",  # å°ç©é›»
        "2317",  # é´»æµ·
        "2454",  # è¯ç™¼ç§‘
        "2382",  # å»£é”
        "2603",  # é•·æ¦®
        "3711",  # æ—¥æœˆå…‰æŠ•æ§
        "2449",  # äº¬å…ƒé›»å­
        "3037",  # æ¬£èˆˆ
        "2308",  # å°é”é›»
        "2395",  # ç ”è¯
        "5347",  # ä¸–ç•Œ
        "2486",  # ä¸€è©®
        "4919",  # æ–°å”
        "6187",  # è¬æ½¤
        "2609",  # é™½æ˜
        "3481",  # ç¾¤å‰µ
        "3019",  # äºå…‰
        "2379",  # ç‘æ˜±
        "3231",  # ç·¯å‰µ
        "8064",  # æ±æ·
        "2356",  # è‹±æ¥­é”
        "2882",  # åœ‹æ³°é‡‘
        "2881",  # å¯Œé‚¦é‡‘
        "2880",  # è¯å—é‡‘
        "2886",  # å…†è±é‡‘
        "2885",  # å…ƒå¤§é‡‘
        "2884",  # ç‰å±±é‡‘
        "2883",  # é–‹ç™¼é‡‘
        "2887",  # å°æ–°é‡‘
        "2888",  # æ–°å…‰é‡‘
        
        # å¤§å‹è‚¡ (31-60)
        "2889",  # åœ‹ç¥¨é‡‘
        "2890",  # æ°¸è±é‡‘
        "2891",  # ä¸­ä¿¡é‡‘
        "2892",  # ç¬¬ä¸€é‡‘
        "5880",  # åˆåº«é‡‘
        "2834",  # è‡ºä¼éŠ€
        "2836",  # é«˜é›„éŠ€
        "2838",  # è¯é‚¦éŠ€
        "2845",  # é æ±éŠ€
        "2849",  # å®‰æ³°éŠ€
        "1101",  # å°æ³¥
        "1102",  # äºæ³¥
        "1216",  # çµ±ä¸€
        "1301",  # å°å¡‘
        "1303",  # å—äº
        "1326",  # å°åŒ–
        "1402",  # é æ±æ–°
        "1590",  # äºå¾·å®¢-KY
        "1605",  # è¯æ–°
        "1717",  # é•·èˆˆ
        "2002",  # ä¸­é‹¼
        "2027",  # å¤§æˆé‹¼
        "2105",  # æ­£æ–°
        "2201",  # è£•éš†
        "2207",  # å’Œæ³°è»Š
        "2301",  # å…‰å¯¶ç§‘
        "2303",  # è¯é›»
        "2324",  # ä»å¯¶
        "2344",  # è¯é‚¦é›»
        "2347",  # è¯å¼·
        
        # ä¸­å¤§å‹è‚¡ (61-90)
        "2351",  # é †å¾·
        "2353",  # å®ç¢
        "2354",  # é´»æº–
        "2355",  # æ•¬éµ¬
        "2357",  # è¯ç¢©
        "2360",  # è‡´èŒ‚
        "2362",  # è—å¤©
        "2365",  # æ˜†ç›ˆ
        "2367",  # ç‡¿è¯
        "2368",  # é‡‘åƒé›»
        "2369",  # è±ç”Ÿ
        "2371",  # å¤§åŒ
        "2376",  # æŠ€å˜‰
        "2408",  # å—äºç§‘
        "2409",  # å‹é”
        "2412",  # ä¸­è¯é›»
        "2474",  # å¯æˆ
        "2492",  # è¯æ–°ç§‘
        "2498",  # å®é”é›»
        "2542",  # èˆˆå¯Œç™¼
        "2547",  # æ—¥å‹ç”Ÿ
        "2606",  # è£•æ°‘
        "2610",  # è¯èˆª
        "2615",  # è¬æµ·
        "2618",  # é•·æ¦®èˆª
        "2637",  # æ…§æ´‹-KY
        "2641",  # æ­£å¾·
        "2727",  # ç‹å“
        "2801",  # å½°éŠ€
        "2823",  # ä¸­å£½
        
        # ä¸­å‹è‚¡ (91-120)
        "2867",  # ä¸‰å•†å£½
        "2912",  # çµ±ä¸€è¶…
        "3008",  # å¤§ç«‹å…‰
        "3029",  # é›¶å£¹
        "3034",  # è¯è© 
        "3035",  # æ™ºåŸ
        "3036",  # æ–‡æ›„
        "3041",  # æšæ™º
        "3043",  # ç§‘é¢¨
        "3044",  # å¥é¼
        "3045",  # å°ç£å¤§
        "3047",  # è¨ŠèˆŸ
        "3048",  # ç›Šç™»
        "3049",  # å’Œé‘«
        "3050",  # éˆºå¾·
        "3051",  # åŠ›ç‰¹
        "3052",  # å¤†å…¸
        "3054",  # ç«‹å¾·
        "3055",  # è”šè¯ç§‘
        "3056",  # ç¸½å¤ª
        "3057",  # å–¬é¼
        "3058",  # ç«‹å¾·
        "3059",  # è¯æ™¶ç§‘
        "3060",  # éŠ˜ç•°
        "3061",  # ç’¨åœ“
        "3062",  # å»ºæ¼¢
        "3090",  # æ—¥é›»è²¿
        "3094",  # è¯å‚‘
        "3130",  # ä¸€é›¶å››
        "3149",  # æ­£é”
        
        # ä¸­å°å‹è‚¡ (121-150)
        "3164",  # æ™¯å²³
        "3189",  # æ™¯ç¢©
        "3209",  # å…¨ç§‘
        "3227",  # åŸç›¸
        "3231",  # ç·¯å‰µ
        "3257",  # è™¹å† é›»
        "3264",  # æ¬£éŠ“
        "3266",  # æ˜‡é™½
        "3296",  # å‹å¾·
        "3305",  # æ˜‡è²¿
        "3308",  # è¯å¾·
        "3311",  # é–æš‰
        "3312",  # å¼˜æ†¶è‚¡
        "3321",  # åŒæ³°
        "3338",  # æ³°ç¢©
        "3356",  # å¥‡å¶
        "3376",  # æ–°æ—¥èˆˆ
        "3380",  # æ˜æ³°
        "3383",  # æ–°ä¸–ç´€
        "3406",  # ç‰æ™¶å…‰
        "3413",  # äº¬é¼
        "3416",  # èç¨‹é›»
        "3419",  # è­è£•
        "3443",  # å‰µæ„
        "3454",  # æ™¶ç¿
        "3481",  # ç¾¤å‰µ
        "3515",  # è¯æ“
        "3518",  # æŸé¨°
        "3529",  # åŠ›æ—º
        "3533",  # å˜‰æ¾¤
        
        # å°å‹è‚¡ (151-180)
        "3545",  # æ•¦æ³°
        "3576",  # è¯åˆå†ç”Ÿ
        "3583",  # è¾›è€˜
        "3588",  # é€šå˜‰
        "3591",  # è‰¾ç¬›æ£®
        "3593",  # åŠ›éŠ˜
        "3596",  # æ™ºæ˜“
        "3661",  # ä¸–èŠ¯-KY
        "3673",  # TPK-KY
        "3679",  # æ–°è‡³é™
        "3682",  # äºå¤ªé›»
        "3694",  # æµ·è¯
        "3701",  # å¤§çœ¾æ§
        "3702",  # å¤§è¯å¤§
        "3703",  # æ¬£é™¸
        "3704",  # åˆå‹¤æ§
        "3705",  # æ°¸ä¿¡
        "3706",  # ç¥é”
        "3708",  # ä¸Šç·¯æŠ•æ§
        "4904",  # é å‚³
        "4906",  # æ­£æ–‡
        "4915",  # è‡´ä¼¸
        "4919",  # æ–°å”
        "4938",  # å’Œç¢©
        "4958",  # è‡»é¼-KY
        "4968",  # ç«‹ç©
        "4976",  # ä½³ä¸–é”
        "4977",  # çœ¾é”-KY
        "4999",  # é‘«ç¦¾
        "5269",  # ç¥¥ç¢©
        "5285"   # ç•Œéœ–
    ]
    
    return taiwan_top_180


def save_stock_list_to_config():
    """å°‡è‚¡ç¥¨æ¸…å–®å„²å­˜åˆ°é…ç½®æª”æ¡ˆ"""
    try:
        from market_data_collector.utils import config
        
        stock_list = generate_taiwan_stock_list()
        
        # æ›´æ–°é…ç½®æª”æ¡ˆä¸­çš„STOCK_IDS
        config_file = Path(__file__).parent / "market_data_collector" / "utils" / "config.py"
        
        if config_file.exists():
            with open(config_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # æ‰¾åˆ°STOCK_IDSçš„å®šç¾©ä¸¦æ›¿æ›
            import re
            pattern = r'STOCK_IDS\s*=\s*\[.*?\]'
            
            new_stock_ids = f"STOCK_IDS = {stock_list}"
            
            if re.search(pattern, content, re.DOTALL):
                content = re.sub(pattern, new_stock_ids, content, flags=re.DOTALL)
            else:
                # å¦‚æœæ‰¾ä¸åˆ°ï¼Œåœ¨æª”æ¡ˆæœ«å°¾æ·»åŠ 
                content += f"\n\n# æ›´æ–°çš„è‚¡ç¥¨æ¸…å–®\n{new_stock_ids}\n"
            
            with open(config_file, 'w', encoding='utf-8') as f:
                f.write(content)
            
            print(f"âœ… å·²æ›´æ–°è‚¡ç¥¨æ¸…å–®åˆ° {config_file}")
            print(f"ğŸ“Š ç¸½å…± {len(stock_list)} æ”¯è‚¡ç¥¨")
        else:
            print(f"âŒ æ‰¾ä¸åˆ°é…ç½®æª”æ¡ˆ: {config_file}")
            
    except Exception as e:
        print(f"âŒ æ›´æ–°é…ç½®æª”æ¡ˆå¤±æ•—: {e}")


def main():
    """ä¸»å‡½æ•¸"""
    print("=== å°è‚¡180æ”¯è‚¡ç¥¨æ¸…å–®ç”Ÿæˆå™¨ ===")
    
    stock_list = generate_taiwan_stock_list()
    
    print(f"ç”Ÿæˆè‚¡ç¥¨æ¸…å–®ï¼Œå…± {len(stock_list)} æ”¯è‚¡ç¥¨:")
    
    # åˆ†çµ„é¡¯ç¤º
    for i in range(0, len(stock_list), 10):
        group = stock_list[i:i+10]
        print(f"  {i+1:3d}-{min(i+10, len(stock_list)):3d}: {', '.join(group)}")
    
    # è©¢å•æ˜¯å¦è¦æ›´æ–°é…ç½®æª”æ¡ˆ
    choice = input("\næ˜¯å¦è¦æ›´æ–°åˆ°é…ç½®æª”æ¡ˆï¼Ÿ(y/N): ").strip().lower()
    if choice == 'y':
        save_stock_list_to_config()
    
    return stock_list


if __name__ == "__main__":
    main()